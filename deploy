
#!/bin/bash


# Kirby CMS FTP Deployment Script (lftp version)

LOCAL_DIR="$(pwd)/"

# Use existing credentials for FTP
FTP_HOST="45.84.207.187"
FTP_USER="u430633202"
FTP_PASS='Wm7&S47!GQ0Zf!e!hQ2&' # <-- Set your FTP password here

# Staging and Production remote paths
STAGING_PATH="/domains/staging.icrn.live/public_html"
PROD_PATH="/domains/icrn.live/public_html"

# Exclude patterns (space-separated, glob style)

# Exclude patterns for lftp mirror (multi-line for readability)
EXCLUDES="--exclude-glob .git --exclude-glob .git/ --exclude-glob .git* --exclude-glob node_modules --exclude-glob node_modules/ --exclude-glob src --exclude-glob src/ --exclude-glob .env --exclude-glob .dev --exclude-glob deploy.sh --exclude-glob composer.lock --exclude-glob package.json --exclude-glob package-lock.json --exclude-glob yarn.lock --exclude-glob site/sessions --exclude-glob site/sessions/ --exclude-glob site/cache --exclude-glob site/cache/ --exclude-glob site/accounts --exclude-glob site/accounts/ --exclude-glob media--exclude-glob media/"

ERRORSTRING="Whoops! That didn't work. Please check the command you ran."

if [ $# -eq 0 ]; then
  echo "$ERRORSTRING"
  exit 1
fi

deploy() {
  REMOTE_PATH=$1
  DRYRUN=$2
  if [ "$DRYRUN" = "dry" ]; then
    echo "[DRY RUN] Would upload to $REMOTE_PATH"
    lftp -u "$FTP_USER","$FTP_PASS" $FTP_HOST -e "set ssl:verify-certificate no; mirror --parallel=8 --reverse --verbose -n --delete $EXCLUDES $LOCAL_DIR $REMOTE_PATH; quit"
  else
    echo "Uploading to $REMOTE_PATH"
    lftp -u "$FTP_USER","$FTP_PASS" $FTP_HOST -e "set ssl:verify-certificate no; mirror --parallel=8 --reverse --verbose --delete $EXCLUDES $LOCAL_DIR $REMOTE_PATH; quit"
  fi
}

sync_content() {
  REMOTE_PATH=$1/content
  DRYRUN=$2
  if [ "$DRYRUN" = "dry" ]; then
    echo "[DRY RUN] Would sync content to $REMOTE_PATH"
    lftp -u "$FTP_USER","$FTP_PASS" $FTP_HOST -e "mirror --reverse --dry-run --delete content $REMOTE_PATH; quit"
  else
    echo "Syncing content to $REMOTE_PATH"
    lftp -u "$FTP_USER","$FTP_PASS" $FTP_HOST -e "mirror --reverse --delete content $REMOTE_PATH; quit"
  fi
}

case "$1" in
  staging)
    if [[ "$2" == "go" ]]; then
      deploy "$STAGING_PATH" "live"
    else
      deploy "$STAGING_PATH" "dry"
    fi
    ;;
  production)
    if [[ "$2" == "go" ]]; then
      deploy "$PROD_PATH" "live"
    else
      deploy "$PROD_PATH" "dry"
    fi
    ;;
  sync-staging)
    if [[ "$2" == "go" ]]; then
      sync_content "$STAGING_PATH" "live"
    else
      sync_content "$STAGING_PATH" "dry"
    fi
    ;;
  sync-production)
    if [[ "$2" == "go" ]]; then
      sync_content "$PROD_PATH" "live"
    else
      sync_content "$PROD_PATH" "dry"
    fi
    ;;
  preview-staging)
    echo "[PREVIEW] Files that would change on STAGING ($STAGING_PATH):"
    lftp -u "$FTP_USER","$FTP_PASS" $FTP_HOST -e "mirror --reverse --dry-run --delete $EXCLUDES $LOCAL_DIR $STAGING_PATH; quit" | grep -E 'Uploading|Deleting|Transferring|Creating directory'
    ;;
  preview-production)
    echo "[PREVIEW] Files that would change on PRODUCTION ($PROD_PATH):"
    lftp -u "$FTP_USER","$FTP_PASS" $FTP_HOST -e "mirror --reverse --dry-run --delete $EXCLUDES $LOCAL_DIR $PROD_PATH; quit" | grep -E 'Uploading|Deleting|Transferring|Creating directory'
    ;;
  *)
    echo "$ERRORSTRING"
    ;;
esac